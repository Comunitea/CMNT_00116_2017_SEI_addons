{% for invoice in invoices %}5{{invoice.partner_id.ref|r(5)}}{{invoice.date_invoice|a3_date|l(8)}}{{'refund' in invoice.type and 2 or 1}}{{invoice.partner_id._get_customer_account(invoice.account_id)|l(12)}}{{invoice.partner_id.name|l(30)}}{{'out' in invoice.type and 1 or 2}}{{invoice.number|l(10)}}I{{invoice.name|l(30)}}{{invoice.amount_total|a3_float|r(14)}}{{' '|l(62)}}{{invoice.partner_id.a3_vat|l(14)}}{{invoice.partner_id.name|l(40)}}{{invoice.partner_id.zip|l(5)}}  {{invoice.operation_date|a3_date|l(8)}}{{invoice.date_invoice|a3_date|l(8)}}{{invoice.number|l(60)}}{{' '|l(196)}}EN
{% for line in invoice.invoice_line_ids %}5{{invoice.partner_id.ref|r(5)}}{{invoice.date_invoice|a3_date|l(8)}}9{{invoice.partner_id._get_customer_account(line.account_id)|l(12)}}{{line.account_id.name|l(30)}}{{'refund' in invoice.type and 'A' or 'C'}}{{invoice.number|l(10)}}{{line==invoice.invoice_line_ids[-1] and 'U' or 'M'}}{{line.name|l(30)}}{{(invoice.fiscal_position_id and invoice.fiscal_position_id.a3_code or '01')|r(2)}}{{line.price_subtotal|a3_float|r(14)}}{{line.a3_get_tax()[0]|a3_float(5, False)}}{{line.a3_get_tax()[1]|a3_float}}{{line.a3_get_surcharge()[0]|a3_float(5, False)}}{{line.a3_get_surcharge()[1]|a3_float}}{{line.a3_get_irpf()[0]|a3_float(5, False)}}{{line.a3_get_irpf()[1]|a3_float}}  {{line.a3_get_tax[0] != 0 and 'S' or 'N'}}  {{' '|l(14)}}{{invoice.partner_id._get_customer_account(soportado)|l(12)}}{{invoice.partner_id._get_customer_account(soportado)|l(12)}}{{invoice.partner_id._get_customer_account(retencion)|l(12)}}{{invoice.partner_id._get_customer_account(repercutido)|l(12)}}{{invoice.partner_id._get_customer_account(repercutido)|l(12)}}{{' '|l(257)}}EN
5{{invoice.partner_id.ref|r(5)}}{{invoice.date_invoice|a3_date|l(8)}}4{{' '|l(43)}}{{(invoice.refund_invoice_ids and invoice.refund_invoice_ids[0].date_invoice or '')|a3_date|l(8)}}{{(invoice.refund_invoice_ids and invoice.refund_invoice_ids[0].number or '')|l(60)}}{{(invoice.dua_document_number or '')|l(18)}}{{('in' in invoice.type and invoice.partner_id._get_customer_account(invoice.account_id) or '')|l(12)}}{{' '|l(117)}}S{{' '|l(14)}}N{{" "|l(14)}}{{'out' in invoice.type and "E" or "R"}}{{invoice.number|l(49)}}{{" "|l(156)}}N
{% endfor %}{% endfor %}
